name: $SESSION_ID
digest: create

services:

  #*
    Pre-compute enclave.
    Only when dataset is requested.
  *#
#if ($IS_DATASET_REQUESTED)
  - name: pre-compute
    image_name: pre-compute-image
    mrenclaves: [$PRE_COMPUTE_MRENCLAVE]
    tags: [demo]
    pwd: /
    command: java -jar /app/tee-worker-pre-compute.jar
    fspf_path: /fspf.pb
    fspf_key: $PRE_COMPUTE_FSPF_KEY
    fspf_tag: $PRE_COMPUTE_FSPF_TAG
    environment:
      LD_LIBRARY_PATH: '/usr/lib/jvm/java-11-openjdk/lib/server:/usr/lib/jvm/java-11-openjdk/lib:/usr/lib/jvm/java-11-openjdk/../lib'
      JAVA_TOOL_OPTIONS: -Xmx256m
      IEXEC_TASK_ID: $env.get("IEXEC_TASK_ID")
      IEXEC_PRE_COMPUTE_IN: /pre-compute-in
      IEXEC_PRE_COMPUTE_OUT: /iexec_in
      IEXEC_DATASET_FILENAME: $env.get("IEXEC_DATASET_FILENAME")
      IEXEC_DATASET_KEY: $IEXEC_DATASET_KEY
      IEXEC_DATASET_CHECKSUM: $IEXEC_DATASET_CHECKSUM
#end

  #*
    Application enclave
  *#
  - name: app
    image_name: app-image
    mrenclaves: [$APP_MRENCLAVE]
    tags: [demo]
    pwd: /
    command: $APP_ARGS
    fspf_path: /fspf.pb
    fspf_key: $APP_FSPF_KEY
    fspf_tag: $APP_FSPF_TAG
    environment:
#foreach($key in $env.keySet())
      $key: '$env.get($key)'
#end

  #* 
    Post-compute enclave
  *#
  - name: post-compute
    image_name: post-compute-image
    mrenclaves: [$POST_COMPUTE_MRENCLAVE]
    tags: [demo]
    pwd: /
    command: java -jar /app/tee-worker-post-compute.jar
    fspf_path: /fspf.pb
    fspf_key: $POST_COMPUTE_FSPF_KEY
    fspf_tag: $POST_COMPUTE_FSPF_TAG
    environment:
      LD_LIBRARY_PATH: '/usr/lib/jvm/java-11-openjdk/lib/server:/usr/lib/jvm/java-11-openjdk/lib:/usr/lib/jvm/java-11-openjdk/../lib'
      JAVA_TOOL_OPTIONS: -Xmx256m
      RESULT_TASK_ID: $RESULT_TASK_ID
      RESULT_ENCRYPTION: $RESULT_ENCRYPTION
      RESULT_ENCRYPTION_PUBLIC_KEY: $RESULT_ENCRYPTION_PUBLIC_KEY
      RESULT_STORAGE_PROVIDER: $RESULT_STORAGE_PROVIDER
      RESULT_STORAGE_PROXY: $RESULT_STORAGE_PROXY
      RESULT_STORAGE_TOKEN: $RESULT_STORAGE_TOKEN
      RESULT_STORAGE_CALLBACK: $RESULT_STORAGE_CALLBACK
      RESULT_SIGN_WORKER_ADDRESS: $RESULT_SIGN_WORKER_ADDRESS
      RESULT_SIGN_TEE_CHALLENGE_PRIVATE_KEY: $RESULT_SIGN_TEE_CHALLENGE_PRIVATE_KEY

#**
  Images used by each service
*#
images:
  #* pre-compute. Only when dataset is requested *#
#if ($IS_DATASET_REQUESTED)
  - name: pre-compute-image
    mrenclaves: [$PRE_COMPUTE_MRENCLAVE]
    tags: [demo]
    volumes:
      - name: iexec_in
        path: /iexec_in
#end

  #* application *#
  - name: app-image
    mrenclaves: [$APP_MRENCLAVE]
    tags: [demo]
    volumes:
      - name: iexec_in
        path: /iexec_in
      - name: iexec_out
        path: /iexec_out

  #* post-compute *#
  - name: post-compute-image
    mrenclaves: [$POST_COMPUTE_MRENCLAVE]
    tags: [demo]
    volumes:
      - name: iexec_out
        path: /iexec_out
      - name: post-compute-tmp
        path: /scone

#**
  Volumes that will be protected
  for each service.
*#
volumes:
  - name: iexec_in
  - name: iexec_out
  - name: post-compute-tmp
