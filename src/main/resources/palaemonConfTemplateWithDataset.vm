name: $SESSION_ID
digest: create

services:
  - name: app
    image_name: image
    mrenclaves: [$APP_MRENCLAVE]
    tags: [demo]
    pwd: /
    command: $APP_ARGS
    fspf_path: /fspf.pb
    fspf_key: $APP_FSPF_KEY
    fspf_tag: $APP_FSPF_TAG
    environment:
      IEXEC_IN: /iexec_in
      IEXEC_OUT: /iexec_out

  - name: post-compute
    image_name: image3
    mrenclaves: [$POST_COMPUTE_MRENCLAVE]
    tags: [demo]
    pwd: /
    command: java -jar /app/tee-worker-post-compute.jar
    fspf_path: /fspf.pb
    fspf_key: $POST_COMPUTE_FSPF_KEY
    fspf_tag: $POST_COMPUTE_FSPF_TAG
    environment:
      LD_LIBRARY_PATH: "/usr/lib/jvm/java-11-openjdk/lib/server:/usr/lib/jvm/java-11-openjdk/lib:/usr/lib/jvm/java-11-openjdk/../lib"
      JAVA_TOOL_OPTIONS: -Xmx256m
      RESULT_TASK_ID: $RESULT_TASK_ID
      RESULT_ENCRYPTION: $RESULT_ENCRYPTION
      RESULT_ENCRYPTION_PUBLIC_KEY: $RESULT_ENCRYPTION_PUBLIC_KEY
      RESULT_STORAGE_PROVIDER: $RESULT_STORAGE_PROVIDER
      RESULT_STORAGE_PROXY: $RESULT_STORAGE_PROXY
      RESULT_STORAGE_TOKEN: $RESULT_STORAGE_TOKEN
      RESULT_STORAGE_CALLBACK: $RESULT_STORAGE_CALLBACK
      RESULT_SIGN_WORKER_ADDRESS: $RESULT_SIGN_WORKER_ADDRESS
      RESULT_SIGN_TEE_CHALLENGE_PRIVATE_KEY: $RESULT_SIGN_TEE_CHALLENGE_PRIVATE_KEY

images:
  - name: image
    mrenclaves: [$APP_MRENCLAVE]
    tags: [demo]
    volumes:
      - name: iexec_in
        path: /iexec_in
      - name: iexec_out
        path: /iexec_out
  - name: image3
    mrenclaves: [$POST_COMPUTE_MRENCLAVE]
    tags: [demo]
    volumes:
      - name: iexec_out
        path: /iexec_out
      - name: scone
        path: /scone

volumes:
  - name: iexec_in
    fspf_tag: $DATA_FSPF_TAG
    fspf_key: $DATA_FSPF_KEY
  - name: iexec_out
  - name: scone
